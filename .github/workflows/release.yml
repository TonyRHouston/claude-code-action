name: Create Release
on:
  workflow_dispatch: {}
jobs:
  create-release:
    runs-on: ubuntu-latest
    if: "github.event_name == 'workflow_dispatch' ||\n(github.event.workflow_run.conclusion\
      \ == 'success' &&\n github.event.workflow_run.head_branch == 'main' &&\n github.event.workflow_run.event\
      \ == 'push' &&\n startsWith(github.event.workflow_run.head_commit.message, 'chore:\
      \ bump Claude Code to'))\n"
    environment: production
    permissions:
      contents: write
    outputs:
      next_version: ${{ steps.next_version.outputs.next_version }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - name: Get latest tag
      id: get_latest_tag
      run: "# Get only version tags (v + number pattern)\nlatest_tag=$(git tag -l\
        \ 'v[0-9]*' | sort -V | tail -1 || echo \"v0.0.0\")\nif [ -z \"$latest_tag\"\
        \ ]; then\n  latest_tag=\"v0.0.0\"\nfi\necho \"latest_tag=$latest_tag\" >>\
        \ $GITHUB_OUTPUT\necho \"Latest tag: $latest_tag\"\n"
    - name: Calculate next version
      id: next_version
      run: 'latest_tag="${{ steps.get_latest_tag.outputs.latest_tag }}"

        # Remove ''v'' prefix and split by dots

        version=${latest_tag#v}

        IFS=''.'' read -ra VERSION_PARTS <<< "$version"


        # Increment patch version

        major=${VERSION_PARTS[0]:-0}

        minor=${VERSION_PARTS[1]:-0}

        patch=${VERSION_PARTS[2]:-0}

        patch=$((patch + 1))


        next_version="v${major}.${minor}.${patch}"

        echo "next_version=$next_version" >> $GITHUB_OUTPUT

        echo "Next version: $next_version"

        '
    - name: Display dry run info
      if: ${{ inputs.dry_run }}
      run: "echo \"\U0001F50D DRY RUN MODE\"\necho \"Would create tag: ${{ steps.next_version.outputs.next_version\
        \ }}\"\necho \"From commit: ${{ github.sha }}\"\necho \"Previous tag: ${{\
        \ steps.get_latest_tag.outputs.latest_tag }}\"\n"
    - name: Create and push tag
      if: ${{ !inputs.dry_run }}
      run: 'next_version="${{ steps.next_version.outputs.next_version }}"

        git config user.name "github-actions[bot]"

        git config user.email "github-actions[bot]@users.noreply.github.com"


        git tag -a "$next_version" -m "Release $next_version"

        git push origin "$next_version"

        '
    - name: Create Release
      if: ${{ !inputs.dry_run }}
      env:
        GH_TOKEN: ${{ github.token }}
      run: "next_version=\"${{ steps.next_version.outputs.next_version }}\"\n\ngh\
        \ release create \"$next_version\" \\\n  --title \"$next_version\" \\\n  --generate-notes\
        \ \\\n  --latest=false # keep v1 as latest\n"
  update-major-tag:
    needs: create-release
    if: github.event_name == 'workflow_run' || !inputs.dry_run
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: write
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - name: Update major version tag
      run: 'next_version="${{ needs.create-release.outputs.next_version }}"

        # Extract major version (e.g., v0 from v0.0.20)

        major_version=$(echo "$next_version" | cut -d. -f1)


        # Update the major version tag to point to this release

        git config user.name "github-actions[bot]"

        git config user.email "github-actions[bot]@users.noreply.github.com"

        git tag -fa "$major_version" -m "Update $major_version tag to $next_version"

        git push origin "$major_version" --force


        echo "Updated $major_version tag to point to $next_version"

        '
