name: Sync Base Action to claude-code-base-action
on:
  workflow_dispatch: {}
permissions:
  contents: write
jobs:
  sync-base-action:
    name: Sync base-action to claude-code-base-action repository
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 10
    steps:
    - name: Checkout source repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
      with:
        fetch-depth: 1
    - name: Setup SSH and clone target repository
      run: "# Configure SSH with deploy key\nmkdir -p ~/.ssh\necho \"${{ secrets.CLAUDE_CODE_BASE_ACTION_REPO_DEPLOY_KEY\
        \ }}\" > ~/.ssh/deploy_key_base\nchmod 600 ~/.ssh/deploy_key_base\n\n# Configure\
        \ SSH host\ncat > ~/.ssh/config <<EOL\nHost base-action.github.com\n  HostName\
        \ github.com\n  User git\n  IdentityFile ~/.ssh/deploy_key_base\n  StrictHostKeyChecking\
        \ no\nEOL\n\n# Clone the target repository\ngit clone git@base-action.github.com:anthropics/claude-code-base-action.git\
        \ target-repo\n"
    - name: Sync base-action contents
      run: "cd target-repo\n\n# Configure git\ngit config user.name \"GitHub Actions\"\
        \ngit config user.email \"actions@github.com\"\n\n# Remove all existing files\
        \ except .git directory\nfind . -mindepth 1 -maxdepth 1 -name '.git' -prune\
        \ -o -exec rm -rf {} +\n\n# Copy all contents from base-action\ncp -r ../base-action/.\
        \ .\n\n# Prepend mirror disclaimer to README if both files exist\nif [ -f\
        \ \"README.md\" ] && [ -f \"MIRROR_DISCLAIMER.md\" ]; then\n  cat MIRROR_DISCLAIMER.md\
        \ README.md > README.tmp\n  mv README.tmp README.md\nfi\n\n# Check if there\
        \ are any changes\nif git diff --quiet && git diff --staged --quiet; then\n\
        \  echo \"No changes to sync\"\n  exit 0\nfi\n\n# Stage all changes\ngit add\
        \ -A\n\n# Get source commit info for the commit message\nSOURCE_COMMIT=\"\
        ${GITHUB_SHA:0:7}\"\nSOURCE_COMMIT_MESSAGE=$(git -C .. log -1 --pretty=format:\"\
        %s\" || echo \"Update from base-action\")\n\n# Commit with descriptive message\n\
        git commit -m \"Sync from claude-code-action base-action@${SOURCE_COMMIT}\"\
        \ \\\n           -m \"\" \\\n           -m \"Source: anthropics/claude-code-action@${GITHUB_SHA}\"\
        \ \\\n           -m \"Original message: ${SOURCE_COMMIT_MESSAGE}\"\n\n# Push\
        \ to main branch\ngit push origin main\n\necho \"Successfully synced base-action\
        \ to claude-code-base-action\"\n"
    - name: Create sync summary
      if: success()
      run: "echo \"## Sync Summary\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\u2705 Successfully synced \\`base-action\\` directory to [anthropics/claude-code-base-action](https://github.com/anthropics/claude-code-base-action)\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\necho \"- **Source\
        \ commit**: [\\`${GITHUB_SHA:0:7}\\`](https://github.com/anthropics/claude-code-action/commit/${GITHUB_SHA})\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"- **Triggered by**: $GITHUB_EVENT_NAME\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"- **Actor**: @$GITHUB_ACTOR\" >> $GITHUB_STEP_SUMMARY\n"
