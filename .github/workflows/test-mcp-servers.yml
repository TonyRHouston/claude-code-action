name: Test MCP Servers
on:
  workflow_dispatch: {}
jobs:
  test-mcp-integration:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Setup Bun
      uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76
    - name: Install dependencies
      run: 'bun install

        cd base-action/test/mcp-test

        bun install

        '
    - name: Run Claude Code with MCP test
      uses: ./base-action
      id: claude-test
      with:
        prompt: List all available tools
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
      env:
        CLAUDE_WORKING_DIR: ${{ github.workspace }}/base-action/test/mcp-test
    - name: Check MCP server output
      run: "echo \"Checking Claude output for MCP servers...\"\n\n# Parse the JSON\
        \ output\nOUTPUT_FILE=\"${RUNNER_TEMP}/claude-execution-output.json\"\n\n\
        if [ ! -f \"$OUTPUT_FILE\" ]; then\n  echo \"Error: Output file not found!\"\
        \n  exit 1\nfi\n\necho \"Output file contents:\"\ncat $OUTPUT_FILE\n\n# Check\
        \ if mcp_servers field exists in the init event\nif jq -e '.[] | select(.type\
        \ == \"system\" and .subtype == \"init\") | .mcp_servers' \"$OUTPUT_FILE\"\
        \ > /dev/null; then\n  echo \"\u2713 Found mcp_servers in output\"\n  \n \
        \ # Check if test-server is connected\n  if jq -e '.[] | select(.type == \"\
        system\" and .subtype == \"init\") | .mcp_servers[] | select(.name == \"test-server\"\
        \ and .status == \"connected\")' \"$OUTPUT_FILE\" > /dev/null; then\n    echo\
        \ \"\u2713 test-server is connected\"\n  else\n    echo \"\u2717 test-server\
        \ not found or not connected\"\n    jq '.[] | select(.type == \"system\" and\
        \ .subtype == \"init\") | .mcp_servers' \"$OUTPUT_FILE\"\n    exit 1\n  fi\n\
        \  \n  # Check if mcp tools are available\n  if jq -e '.[] | select(.type\
        \ == \"system\" and .subtype == \"init\") | .tools[] | select(. == \"mcp__test-server__test_tool\"\
        )' \"$OUTPUT_FILE\" > /dev/null; then\n    echo \"\u2713 MCP test tool found\"\
        \n  else\n    echo \"\u2717 MCP test tool not found\"\n    jq '.[] | select(.type\
        \ == \"system\" and .subtype == \"init\") | .tools' \"$OUTPUT_FILE\"\n   \
        \ exit 1\n  fi\nelse\n  echo \"\u2717 No mcp_servers field found in init event\"\
        \n  jq '.[] | select(.type == \"system\" and .subtype == \"init\")' \"$OUTPUT_FILE\"\
        \n  exit 1\nfi\n\necho \"\u2713 All MCP server checks passed!\"\n"
  test-mcp-config-flag:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Setup Bun
      uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76
    - name: Install dependencies
      run: 'bun install

        cd base-action/test/mcp-test

        bun install

        '
    - name: Debug environment paths (--mcp-config test)
      run: 'echo "=== Environment Variables (--mcp-config test) ==="

        echo "HOME: $HOME"

        echo ""

        echo "=== Expected Config Paths ==="

        echo "GitHub action writes to: $HOME/.claude/settings.json"

        echo "Claude should read from: $HOME/.claude/settings.json"

        echo ""

        echo "=== Actual File System ==="

        ls -la $HOME/.claude/ || echo "No $HOME/.claude directory"

        '
    - name: Run Claude Code with --mcp-config flag
      uses: ./base-action
      id: claude-config-test
      with:
        prompt: List all available tools
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        mcp_config: '{"mcpServers":{"test-server":{"type":"stdio","command":"bun","args":["simple-mcp-server.ts"],"env":{}}}}'
      env:
        CLAUDE_WORKING_DIR: ${{ github.workspace }}/base-action/test/mcp-test
    - name: Check MCP server output with --mcp-config
      run: "echo \"Checking Claude output for MCP servers with --mcp-config flag...\"\
        \n\n# Parse the JSON output\nOUTPUT_FILE=\"${RUNNER_TEMP}/claude-execution-output.json\"\
        \n\nif [ ! -f \"$OUTPUT_FILE\" ]; then\n  echo \"Error: Output file not found!\"\
        \n  exit 1\nfi\n\necho \"Output file contents:\"\ncat $OUTPUT_FILE\n\n# Check\
        \ if mcp_servers field exists in the init event\nif jq -e '.[] | select(.type\
        \ == \"system\" and .subtype == \"init\") | .mcp_servers' \"$OUTPUT_FILE\"\
        \ > /dev/null; then\n  echo \"\u2713 Found mcp_servers in output\"\n  \n \
        \ # Check if test-server is connected\n  if jq -e '.[] | select(.type == \"\
        system\" and .subtype == \"init\") | .mcp_servers[] | select(.name == \"test-server\"\
        \ and .status == \"connected\")' \"$OUTPUT_FILE\" > /dev/null; then\n    echo\
        \ \"\u2713 test-server is connected\"\n  else\n    echo \"\u2717 test-server\
        \ not found or not connected\"\n    jq '.[] | select(.type == \"system\" and\
        \ .subtype == \"init\") | .mcp_servers' \"$OUTPUT_FILE\"\n    exit 1\n  fi\n\
        \  \n  # Check if mcp tools are available\n  if jq -e '.[] | select(.type\
        \ == \"system\" and .subtype == \"init\") | .tools[] | select(. == \"mcp__test-server__test_tool\"\
        )' \"$OUTPUT_FILE\" > /dev/null; then\n    echo \"\u2713 MCP test tool found\"\
        \n  else\n    echo \"\u2717 MCP test tool not found\"\n    jq '.[] | select(.type\
        \ == \"system\" and .subtype == \"init\") | .tools' \"$OUTPUT_FILE\"\n   \
        \ exit 1\n  fi\nelse\n  echo \"\u2717 No mcp_servers field found in init event\"\
        \n  jq '.[] | select(.type == \"system\" and .subtype == \"init\")' \"$OUTPUT_FILE\"\
        \n  exit 1\nfi\n\necho \"\u2713 All MCP server checks passed with --mcp-config\
        \ flag!\"\n"
