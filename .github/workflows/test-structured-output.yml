name: Test Structured Outputs
on:
  workflow_dispatch: {}
permissions:
  contents: read
jobs:
  test-basic-types:
    name: Test Basic Type Conversions
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Test with explicit values
      id: test
      uses: ./base-action
      with:
        prompt: 'Run this command: echo "test"


          Then return EXACTLY these values:

          - text_field: "hello"

          - number_field: 42

          - boolean_true: true

          - boolean_false: false

          '
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: '--allowedTools Bash

          --json-schema ''{"type":"object","properties":{"text_field":{"type":"string"},"number_field":{"type":"number"},"boolean_true":{"type":"boolean"},"boolean_false":{"type":"boolean"}},"required":["text_field","number_field","boolean_true","boolean_false"]}''

          '
    - name: Verify outputs
      run: "# Parse the structured_output JSON\nOUTPUT='${{ steps.test.outputs.structured_output\
        \ }}'\n\n# Test string pass-through\nTEXT_FIELD=$(echo \"$OUTPUT\" | jq -r\
        \ '.text_field')\nif [ \"$TEXT_FIELD\" != \"hello\" ]; then\n  echo \"\u274C\
        \ String: expected 'hello', got '$TEXT_FIELD'\"\n  exit 1\nfi\n\n# Test number\
        \ \u2192 string conversion\nNUMBER_FIELD=$(echo \"$OUTPUT\" | jq -r '.number_field')\n\
        if [ \"$NUMBER_FIELD\" != \"42\" ]; then\n  echo \"\u274C Number: expected\
        \ '42', got '$NUMBER_FIELD'\"\n  exit 1\nfi\n\n# Test boolean \u2192 \"true\"\
        \ conversion\nBOOLEAN_TRUE=$(echo \"$OUTPUT\" | jq -r '.boolean_true')\nif\
        \ [ \"$BOOLEAN_TRUE\" != \"true\" ]; then\n  echo \"\u274C Boolean true: expected\
        \ 'true', got '$BOOLEAN_TRUE'\"\n  exit 1\nfi\n\n# Test boolean \u2192 \"\
        false\" conversion\nBOOLEAN_FALSE=$(echo \"$OUTPUT\" | jq -r '.boolean_false')\n\
        if [ \"$BOOLEAN_FALSE\" != \"false\" ]; then\n  echo \"\u274C Boolean false:\
        \ expected 'false', got '$BOOLEAN_FALSE'\"\n  exit 1\nfi\n\necho \"\u2705\
        \ All basic type conversions correct\"\n"
  test-complex-types:
    name: Test Arrays and Objects
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Test complex types
      id: test
      uses: ./base-action
      with:
        prompt: 'Run: echo "ready"


          Return EXACTLY:

          - items: ["apple", "banana", "cherry"]

          - config: {"key": "value", "count": 3}

          - empty_array: []

          '
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: '--allowedTools Bash

          --json-schema ''{"type":"object","properties":{"items":{"type":"array","items":{"type":"string"}},"config":{"type":"object"},"empty_array":{"type":"array"}},"required":["items","config","empty_array"]}''

          '
    - name: Verify JSON stringification
      run: "# Parse the structured_output JSON\nOUTPUT='${{ steps.test.outputs.structured_output\
        \ }}'\n\n# Arrays should be JSON stringified\nif ! echo \"$OUTPUT\" | jq -e\
        \ '.items | length == 3' > /dev/null; then\n  echo \"\u274C Array not properly\
        \ formatted\"\n  echo \"$OUTPUT\" | jq '.items'\n  exit 1\nfi\n\n# Objects\
        \ should be JSON stringified\nif ! echo \"$OUTPUT\" | jq -e '.config.key ==\
        \ \"value\"' > /dev/null; then\n  echo \"\u274C Object not properly formatted\"\
        \n  echo \"$OUTPUT\" | jq '.config'\n  exit 1\nfi\n\n# Empty arrays should\
        \ work\nif ! echo \"$OUTPUT\" | jq -e '.empty_array | length == 0' > /dev/null;\
        \ then\n  echo \"\u274C Empty array not properly formatted\"\n  echo \"$OUTPUT\"\
        \ | jq '.empty_array'\n  exit 1\nfi\n\necho \"\u2705 All complex types handled\
        \ correctly\"\n"
  test-edge-cases:
    name: Test Edge Cases
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Test edge cases
      id: test
      uses: ./base-action
      with:
        prompt: 'Run: echo "test"


          Return EXACTLY:

          - zero: 0

          - empty_string: ""

          - negative: -5

          - decimal: 3.14

          '
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: '--allowedTools Bash

          --json-schema ''{"type":"object","properties":{"zero":{"type":"number"},"empty_string":{"type":"string"},"negative":{"type":"number"},"decimal":{"type":"number"}},"required":["zero","empty_string","negative","decimal"]}''

          '
    - name: Verify edge cases
      run: "# Parse the structured_output JSON\nOUTPUT='${{ steps.test.outputs.structured_output\
        \ }}'\n\n# Zero should be \"0\", not empty or falsy\nZERO=$(echo \"$OUTPUT\"\
        \ | jq -r '.zero')\nif [ \"$ZERO\" != \"0\" ]; then\n  echo \"\u274C Zero:\
        \ expected '0', got '$ZERO'\"\n  exit 1\nfi\n\n# Empty string should be empty\
        \ (not \"null\" or missing)\nEMPTY_STRING=$(echo \"$OUTPUT\" | jq -r '.empty_string')\n\
        if [ \"$EMPTY_STRING\" != \"\" ]; then\n  echo \"\u274C Empty string: expected\
        \ '', got '$EMPTY_STRING'\"\n  exit 1\nfi\n\n# Negative numbers should work\n\
        NEGATIVE=$(echo \"$OUTPUT\" | jq -r '.negative')\nif [ \"$NEGATIVE\" != \"\
        -5\" ]; then\n  echo \"\u274C Negative: expected '-5', got '$NEGATIVE'\"\n\
        \  exit 1\nfi\n\n# Decimals should preserve precision\nDECIMAL=$(echo \"$OUTPUT\"\
        \ | jq -r '.decimal')\nif [ \"$DECIMAL\" != \"3.14\" ]; then\n  echo \"\u274C\
        \ Decimal: expected '3.14', got '$DECIMAL'\"\n  exit 1\nfi\n\necho \"\u2705\
        \ All edge cases handled correctly\"\n"
  test-name-sanitization:
    name: Test Output Name Sanitization
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Test special characters in field names
      id: test
      uses: ./base-action
      with:
        prompt: 'Run: echo "test"

          Return EXACTLY: {test-result: "passed", item_count: 10}

          '
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: '--allowedTools Bash

          --json-schema ''{"type":"object","properties":{"test-result":{"type":"string"},"item_count":{"type":"number"}},"required":["test-result","item_count"]}''

          '
    - name: Verify sanitized names work
      run: "# Parse the structured_output JSON\nOUTPUT='${{ steps.test.outputs.structured_output\
        \ }}'\n\n# Hyphens should be preserved in the JSON\nTEST_RESULT=$(echo \"\
        $OUTPUT\" | jq -r '.[\"test-result\"]')\nif [ \"$TEST_RESULT\" != \"passed\"\
        \ ]; then\n  echo \"\u274C Hyphenated name failed: expected 'passed', got\
        \ '$TEST_RESULT'\"\n  exit 1\nfi\n\n# Underscores should work\nITEM_COUNT=$(echo\
        \ \"$OUTPUT\" | jq -r '.item_count')\nif [ \"$ITEM_COUNT\" != \"10\" ]; then\n\
        \  echo \"\u274C Underscore name failed: expected '10', got '$ITEM_COUNT'\"\
        \n  exit 1\nfi\n\necho \"\u2705 Name sanitization works\"\n"
  test-execution-file-structure:
    name: Test Execution File Format
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Run with structured output
      id: test
      uses: ./base-action
      with:
        prompt: 'Run: echo ''complete''. Return: {done: true}'
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        claude_args: '--allowedTools Bash

          --json-schema ''{"type":"object","properties":{"done":{"type":"boolean"}},"required":["done"]}''

          '
    - name: Verify execution file contains structured_output
      run: "FILE=\"${{ steps.test.outputs.execution_file }}\"\n\n# Check file exists\n\
        if [ ! -f \"$FILE\" ]; then\n  echo \"\u274C Execution file missing\"\n  exit\
        \ 1\nfi\n\n# Check for structured_output field\nif ! jq -e '.[] | select(.type\
        \ == \"result\") | .structured_output' \"$FILE\" > /dev/null; then\n  echo\
        \ \"\u274C No structured_output in execution file\"\n  cat \"$FILE\"\n  exit\
        \ 1\nfi\n\n# Verify the actual value\nDONE=$(jq -r '.[] | select(.type ==\
        \ \"result\") | .structured_output.done' \"$FILE\")\nif [ \"$DONE\" != \"\
        true\" ]; then\n  echo \"\u274C Wrong value in execution file\"\n  exit 1\n\
        fi\n\necho \"\u2705 Execution file format correct\"\n"
  test-summary:
    name: Summary
    runs-on: ubuntu-latest
    needs:
    - test-basic-types
    - test-complex-types
    - test-edge-cases
    - test-name-sanitization
    - test-execution-file-structure
    if: always()
    steps:
    - name: Generate Summary
      run: "echo \"# Structured Output Tests (Optimized)\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"Fast, deterministic tests using\
        \ explicit prompts\" >> $GITHUB_STEP_SUMMARY\necho \"\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| Test | Result |\" >> $GITHUB_STEP_SUMMARY\necho \"|------|--------|\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"| Basic Types | ${{ needs.test-basic-types.result\
        \ == 'success' && '\u2705 PASS' || '\u274C FAIL' }} |\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"| Complex Types | ${{ needs.test-complex-types.result == 'success'\
        \ && '\u2705 PASS' || '\u274C FAIL' }} |\" >> $GITHUB_STEP_SUMMARY\necho \"\
        | Edge Cases | ${{ needs.test-edge-cases.result == 'success' && '\u2705 PASS'\
        \ || '\u274C FAIL' }} |\" >> $GITHUB_STEP_SUMMARY\necho \"| Name Sanitization\
        \ | ${{ needs.test-name-sanitization.result == 'success' && '\u2705 PASS'\
        \ || '\u274C FAIL' }} |\" >> $GITHUB_STEP_SUMMARY\necho \"| Execution File\
        \ | ${{ needs.test-execution-file-structure.result == 'success' && '\u2705\
        \ PASS' || '\u274C FAIL' }} |\" >> $GITHUB_STEP_SUMMARY\n\n# Check if all\
        \ passed\nALL_PASSED=${{\n  needs.test-basic-types.result == 'success' &&\n\
        \  needs.test-complex-types.result == 'success' &&\n  needs.test-edge-cases.result\
        \ == 'success' &&\n  needs.test-name-sanitization.result == 'success' &&\n\
        \  needs.test-execution-file-structure.result == 'success'\n}}\n\nif [ \"\
        $ALL_PASSED\" = \"true\" ]; then\n  echo \"\" >> $GITHUB_STEP_SUMMARY\n  echo\
        \ \"## \u2705 All Tests Passed\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\"\
        \ >> $GITHUB_STEP_SUMMARY\n  echo \"## \u274C Some Tests Failed\" >> $GITHUB_STEP_SUMMARY\n\
        \  exit 1\nfi\n"
